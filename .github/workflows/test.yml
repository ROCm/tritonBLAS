name: Tests

on:
  push:
    branches: [ main]
  pull_request:
    branches: [ main]
  workflow_dispatch:

jobs:
  test:
    runs-on: [self-hosted, amd-gpu]
    
    container:
      image: rocm/dev-ubuntu-24.04:7.2-complete
      options: --device=/dev/kfd --device=/dev/dri --group-add video --ipc=host --cap-add=SYS_PTRACE --security-opt seccomp=unconfined
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Set up environment
        run: |
          echo "Setting up ROCm environment..."
          export ROCM_PATH=/opt/rocm
          export PATH=$ROCM_PATH/bin:$PATH
          
      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y git python3.12 python3.12-venv python3-pip python3.12-dev
          update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1

      - name: Install PyTorch (ROCm)
        run: |
          python3 -m pip install --upgrade pip
          pip3 install torch --index-url https://download.pytorch.org/whl/rocm7.1

      - name: Install Python dependencies
        run: |
          pip3 install -U triton
          pip3 install -e .
          
      - name: Verify installation
        run: |
          python3 -c "import tritonblas; print('tritonBLAS imported successfully')"
          python3 -c "import torch; print(f'PyTorch version: {torch.__version__}')"
          python3 -c "import torch; print(f'CUDA available: {torch.cuda.is_available()}')"
          python3 -c "import torch; print(f'CUDA device count: {torch.cuda.device_count()}')"
          if python3 -c "import torch; exit(0 if torch.cuda.is_available() else 1)"; then
            python3 -c "import torch; print(f'CUDA device name: {torch.cuda.get_device_name(0)}')"
          fi
          
      - name: Run linting
        run: |
          pip3 install ruff
          ruff check include/ tests/ --output-format=github
        continue-on-error: true
        
      - name: Run tests
        run: |
          export PYTHONPATH=$(pwd)/include/:$PYTHONPATH
          # Skip matmul tests that use torch.matmul as reference - hipBLASLt library missing in container for gfx942
          pytest tests/ -v --tb=short --color=yes --ignore=tests/test_matmul_a8w8_lt.py --ignore=tests/test_matmul_fp4.py -m "not performance"
        
      - name: Generate test report
        if: always()
        run: |
          # Skip matmul tests that use torch.matmul as reference - hipBLASLt library missing in container for gfx942
          pytest tests/ -v --tb=short --junit-xml=test-results.xml --ignore=tests/test_matmul_a8w8_lt.py --ignore=tests/test_matmul_fp4.py
        continue-on-error: true
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results.xml
          retention-days: 30
  
  performance-test:
    needs: test
    runs-on: [self-hosted, amd-gpu]
    continue-on-error: true
    
    container:
      image: rocm/7.0-preview:rocm7.0_preview_pytorch_training_mi35x_beta
      options: --device=/dev/kfd --device=/dev/dri --group-add video --ipc=host --cap-add=SYS_PTRACE --security-opt seccomp=unconfined
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Set up environment
        run: |
          echo "Setting up ROCm environment..."
          export ROCM_PATH=/opt/rocm
          export PATH=$ROCM_PATH/bin:$PATH
          
      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y git
          
      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip3 install -U triton
          pip3 install -e .
          
      - name: Run performance benchmarks
        run: |
          export PYTHONPATH=$(pwd)/include/:$PYTHONPATH
          pytest tests/test_performance.py::test_mi350_performance_report -s -v --tb=short --color=yes
          
      - name: Upload performance results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: |
            performance-results.json
            performance-report.txt
          retention-days: 30
      #This doesn't work on 300 runners.  
      # - name: Run FP4 performance benchmarks
      #   run: |
      #     export PYTHONPATH=$(pwd)/include/:$PYTHONPATH
      #     pytest tests/test_matmul_fp4.py -v -s --tb=short --color=yes -m performance
